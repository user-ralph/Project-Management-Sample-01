<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../style-sheets/user-main-page.css" />
    <link rel="icon" href="../image-source/set-web-icon.png" />

    <title>COIS - Browse Service</title>
  </head>
  <body>
    <nav class="navbar">
      <h4 class="page-title">Scholar Access</h4>
      <div class="profile">
        <input type="text" placeholder="Search..." id="user-search" />
        <i class="bx bx-search"></i>
        <div class="dropdown">
          <a
            class="btn btn-secondary dropdown-toggle"
            href="user-dashboard-main.html"
            role="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <img
              class="profile-image"
              src="../image-source/student-icon.png"
              alt=""
            />
            Scholar Tab
          </a>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item" href="user-scholar-status.html"
                >Scholar Status</a
              >
            </li>
            <li>
              <a class="dropdown-item" href="../home-page-user.html">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <input type="checkbox" id="toggle" />
    <label for="toggle" class="side-toggle"><i class="bx bx-menu"></i></label>

    <div class="sidebar">
      <div class="sidebar-content">
        <ul class="lists">
          <li class="list">
            <a class="nav-link" id="dashboardlink">
              <i class="bx bxs-dashboard icon"></i>
              <span class="link">Dashboard</span>
            </a>
          </li>
          <li class="list">
            <a class="nav-link" id="ScholarStatuslink">
              <i class="bx bxs-user-account icon"></i>
              <span class="link">Scholar Status</span>
            </a>
          </li>
          <li class="list">
            <a class="nav-link" id="notificationLink">
              <i class="bx bx-notification icon"></i>
              <span class="link">Announcements</span>
            </a>
          </li>
          <li class="list">
            <a class="nav-link" id="BrowseServicelink">
              <i class="bx bx-category icon"></i>
              <span class="link">Browse Service</span>
            </a>
          </li>
          <li class="list">
            <a class="nav-link" id="ConnectAdminlink">
              <i class="bx bx-message-edit icon"></i>
              <span class="link">Connect Admin</span>
            </a>
          </li>
          <li class="list">
            <a class="nav-link" id="UploadAttachmentslink">
              <i class="bx bx-upload icon"></i>
              <span class="link">Upload Attachments</span>
            </a>
          </li>
          <li class="list">
            <a class="nav-link" id="DownlaodCSRlink">
              <i class="bx bxs-download icon"></i>
              <span class="link">Downlaod CSR</span>
            </a>
          </li>
        </ul>
        <div class="bottom-content">
          <li class="list-bottom">
            <a href="../home-page-user.html?${userId}" class="nav-link">
              <i class="bx bx-log-out icon"></i>
              <span class="link">Logout</span>
            </a>
          </li>
        </div>
      </div>
    </div>

    <main class="mt-5 pt-3">
      <p class="user-page-title">Browse Service</p>
      <nav aria-label="breadcrumb" style="margin-left: 10px">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="admin-dashboard-main.html">Dashboard</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            Browse Service
          </li>
        </ol>
      </nav>

      <nav class="nav nav-content1" style="margin-bottom: 10px">
        <a
          class="nav-link active nav-hover-contentA"
          aria-current="page"
          href="#"
          >All</a
        >
      </nav>

      <div
        class="row row-cols-1 row-cols-md-3 g-4"
        style="margin-left: 1px"
      ></div>

      <!-- Button trigger modal -->

      <!-- Modal -->
    </main>

    <div
      class="modal fade modal-dialog-scrollable"
      id="staticBackdrop-content1"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5">Rendered Service Opportunity</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="content-imagesize">
            <div id="carouselExampleIndicators" class="carousel slide">
              <div class="carousel-indicators">
                <button
                  type="button"
                  data-bs-target="#carouselExampleIndicators"
                  data-bs-slide-to="0"
                  class="active"
                  aria-current="true"
                  aria-label="Slide 1"
                ></button>
                <button
                  type="button"
                  data-bs-target="#carouselExampleIndicators"
                  data-bs-slide-to="1"
                  aria-label="Slide 2"
                ></button>
                <button
                  type="button"
                  data-bs-target="#carouselExampleIndicators"
                  data-bs-slide-to="2"
                  aria-label="Slide 3"
                ></button>
              </div>
              <div class="carousel-inner">
                <div class="carousel-item active">
                  <img
                    src="../image-source/adminnotif1.jpg"
                    class="d-block w-100"
                    alt="..."
                    id="rendered-image-reference-1"
                  />
                </div>
              </div>
              <button
                class="carousel-control-prev"
                type="button"
                data-bs-target="#carouselExampleIndicators"
                data-bs-slide="prev"
              >
                <span
                  class="carousel-control-prev-icon"
                  aria-hidden="true"
                ></span>
                <span class="visually-hidden">Previous</span>
              </button>
              <button
                class="carousel-control-next"
                type="button"
                data-bs-target="#carouselExampleIndicators"
                data-bs-slide="next"
              >
                <span
                  class="carousel-control-next-icon"
                  aria-hidden="true"
                ></span>
                <span class="visually-hidden">Next</span>
              </button>
            </div>
          </div>

          <div class="card admin-rendered-content">
            <div
              id="rendered-service-title"
              class="card-header admin-notif-contenttitle"
            >
              Rendered Service Opportunity
            </div>
            <div class="card-body">
              <blockquote class="blockquote mb-0">
                <p id="rendered-service-content-text">...</p>
              </blockquote>
            </div>
          </div>

          <div class="card border-success" style="margin: 15px">
            <div class="card-header">Render Service</div>
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                Where:
                <p id="renderedService-where">...</p>
              </li>
              <li class="list-group-item">
                When:
                <p id="renderedService-when"></p>
              </li>
            </ul>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
            >
              Understood
            </button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
      import {
        getDatabase,
        set,
        ref,
        child,
        onValue,
        get,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";
      import {
        getStorage,
        ref as dbRef,
        uploadBytes,
        list,
        getDownloadURL,
        listAll,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js";

      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        var results = regex.exec(location.search);
        return results === null
          ? ""
          : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      var userId = getUrlParameter("uid");

      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyAXTWA8tDgh36kHxr3oiI2mdZk4xN1ExIU",
        authDomain: "coisprojectmain.firebaseapp.com",
        projectId: "coisprojectmain",
        storageBucket: "coisprojectmain.appspot.com",
        messagingSenderId: "666040501925",
        appId: "1:666040501925:web:a53d190dbffca2ceac2f4c",
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const storage = getStorage(app);

      //////////// POST STATIC DISPLAY FROM FIREBASE
      document.addEventListener("DOMContentLoaded", function () {
        const database = getDatabase(app);
        const postsRef = ref(database, "posts"); // Reference to the 'posts' node in Firebase

        // Fetch data from Firebase
        onValue(postsRef, (snapshot) => {
          const posts = snapshot.val(); // Retrieved posts from Firebase

          // Get the container where you want to display the posts
          const cardContainer = document.querySelector(
            ".row.row-cols-1.row-cols-md-3.g-4"
          );

          // Function to format text content with line breaks and clickable links
          function formatText(text) {
            const formattedText = text
              .split("\n")
              .map((line) => {
                if (line.match(/https?:\/\/[^\s]+/)) {
                  return `<p>${linkify(line)}</p>`;
                }
                return `<p>${line}</p>`;
              })
              .join("");

            return formattedText;
          }

          // Loop through the posts
          for (const key in posts) {
            const postData = posts[key]; // Retrieve individual post data

            // Create HTML elements dynamically and populate them with fetched data
            const newCard = document.createElement("div");
            newCard.className = "col";
            newCard.innerHTML = `
            <div class="card admin-browse-content1">
              <img src="../image-source/rendered-service-poster1.png" class="card-img-top rendered-service-poster1" alt="...">
              <div class="card-body">
                <h5 class="card-title admin-browse-title-1">${postData.title}</h5>
                <p class="card-text admin-notif-text-render">${postData.when}</p>
                <!-- Add other HTML elements here to display more data -->
                <button type="button" class="btn btn-primary admin-notif-btn-render" data-bs-toggle="modal" data-bs-target="#staticBackdrop-content1" data-bs-content="${key}">View More Details</button>
              
              </div>
            </div>
          `;

            // Append the newly created card to the card container
            cardContainer.appendChild(newCard);
            // Call the function to update the profile picture

            // Add event listener to the 'View More Details' button
            newCard
              .querySelector(".admin-notif-btn-render")
              .addEventListener("click", function () {
                // Update modal content with Firebase data
                document.getElementById("rendered-service-title").innerText =
                  postData.title;
                document.getElementById(
                  "rendered-service-content-text"
                ).innerHTML = postData.content; // You can set the content here
                document.getElementById("renderedService-where").innerText =
                  postData.where;
                document.getElementById("renderedService-when").innerText =
                  postData.when;
                postPicture(key);
              });
          }

          function postPicture(number) {
            console.log(number);
            const storageRef = dbRef(storage, `posts/${number}`);

            listAll(storageRef)
              .then((res) => {
                if (res.items.length > 0) {
                  // Sort items by their metadata (creation time)
                  const sortedItems = res.items.sort(
                    (a, b) => b.timeCreated - a.timeCreated
                  );

                  // Get the most recent item (first item after sorting)
                  const mostRecentItem = sortedItems[0];

                  // Fetch download URL for the most recent item
                  getDownloadURL(mostRecentItem).then((url) => {
                    const profilePic = document.getElementById(
                      "rendered-image-reference-1"
                    );
                    profilePic.src = url;
                  });
                } else {
                  console.error("No images found in the folder");
                }
              })
              .catch((error) => {
                console.error("Error listing files:", error);
              });
          }
        });
      });

      console.log("User ID:", userId);
      var notificationLink = document.getElementById("notificationLink");
      var dashboardlink = document.getElementById("dashboardlink");
      var ScholarStatuslink = document.getElementById("ScholarStatuslink");
      var BrowseServicelink = document.getElementById("BrowseServicelink");
      var ConnectAdminlink = document.getElementById("ConnectAdminlink");
      var UploadAttachmentslink = document.getElementById(
        "UploadAttachmentslink"
      );
      var DownlaodCSRlink = document.getElementById("DownlaodCSRlink");
      var ViewRenderedServiceslink = document.getElementById(
        "ViewRenderedServiceslink"
      );

      if (userId && ScholarStatuslink) {
        ScholarStatuslink.href = "user-scholar-status.html?uid=" + userId;
      }
      if (userId && notificationLink) {
        notificationLink.href = "user-notification.html?uid=" + userId;
      }
      if (userId && dashboardlink) {
        dashboardlink.href = "user-dashboard-main.html?uid=" + userId;
      }
      if (userId && BrowseServicelink) {
        BrowseServicelink.href = "user-browse-service.html?uid=" + userId;
      }
      if (userId && ConnectAdminlink) {
        ConnectAdminlink.href = "user-connect-admin.html?uid=" + userId;
      }
      if (userId && UploadAttachmentslink) {
        UploadAttachmentslink.href =
          "user-upload-attachments.html?uid=" + userId;
      }
      if (userId && DownlaodCSRlink) {
        DownlaodCSRlink.href = "user-download.html?uid=" + userId;
      }
      if (userId && ViewRenderedServiceslink) {
        ViewRenderedServiceslink.href =
          "user-view-rendered-services.html?uid=" + userId;
      }
    </script>
  </body>
</html>
